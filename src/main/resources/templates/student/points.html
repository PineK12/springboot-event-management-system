<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Điểm rèn luyện - Sinh Viên VADOO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { sv: '#F97316', svDark: '#C2410C', svLight: '#FFF7ED' }
                }
            }
        }
    </script>
    <style>
        .sidebar-item.active { background-color: #FFF7ED; color: #F97316; font-weight: 600; border-right: 3px solid #F97316; }

        /* Circular Progress Bar CSS */
        .progress-circle {
            width: 150px; height: 150px; border-radius: 50%;
            background: conic-gradient(var(--color) var(--percent), #f3f4f6 0deg);
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .progress-circle::before {
            content: ""; position: absolute;
            width: 120px; height: 120px; border-radius: 50%; background: white;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

<div class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-white hidden md:flex flex-col border-r border-gray-200 shadow-sm z-20">
        <div class="p-6 flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-orange-400 to-red-500 text-white flex items-center justify-center font-bold text-xl shadow-lg">V</div>
            <div>
                <h1 class="text-xl font-bold tracking-tight text-gray-800">VADOO</h1>
                <p class="text-[10px] text-gray-400 uppercase tracking-widest font-semibold">Student Portal</p>
            </div>
        </div>
        <nav class="flex-1 px-4 space-y-2 py-4">
            <a th:href="@{/student/dashboard}" class="sidebar-item flex items-center gap-4 px-4 py-3 rounded-lg text-gray-500 hover:bg-gray-50"><i class="fas fa-th-large w-5"></i> Trang chủ</a>
            <a th:href="@{/student/events}" class="sidebar-item flex items-center gap-4 px-4 py-3 rounded-lg text-gray-500 hover:bg-gray-50"><i class="fas fa-calendar-alt w-5"></i> Sự kiện</a>
            <a th:href="@{/student/my-qr}" class="sidebar-item flex items-center gap-4 px-4 py-3 rounded-lg text-gray-500 hover:bg-gray-50"><i class="fas fa-ticket-alt w-5"></i> QR Vé của tôi</a>
            <a th:href="@{/student/history}" class="sidebar-item flex items-center gap-4 px-4 py-3 rounded-lg text-gray-500 hover:bg-gray-50"><i class="fas fa-history w-5"></i> Lịch sử</a>
            <a th:href="@{/student/points}" class="sidebar-item active flex items-center gap-4 px-4 py-3 rounded-lg text-gray-500 hover:bg-gray-50"><i class="fas fa-star w-5"></i> Điểm rèn luyện</a>
            <a th:href="@{/student/profile}" class="sidebar-item flex items-center gap-4 px-4 py-3 rounded-lg text-gray-500 hover:bg-gray-50"><i class="fas fa-user-circle w-5"></i> Hồ sơ cá nhân</a>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <header class="bg-white sticky top-0 z-30 px-8 py-4 flex justify-between items-center border-b border-gray-100 shadow-sm backdrop-blur-xl bg-white/90">
            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-orange-100 text-sv flex items-center justify-center">
                    <i class="fas fa-chart-line"></i>
                </div>
                Điểm rèn luyện
            </h2>

            <div class="flex items-center gap-4">

                <form th:action="@{/student/points}" method="get">
                    <div class="relative group">
                        <i class="fas fa-calendar-alt absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-hover:text-sv transition-colors z-10"></i>
                        <select name="semester" onchange="this.form.submit()"
                                class="pl-9 pr-10 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-gray-700 cursor-pointer focus:outline-none focus:ring-2 focus:ring-sv focus:bg-white transition-all hover:border-sv appearance-none min-w-[180px]">
                            <option th:each="sem : ${semesters}"
                                    th:value="${sem.key}"
                                    th:text="${sem.value}"
                                    th:selected="${sem.key == currentSemester}"></option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-400 pointer-events-none"></i>
                    </div>
                </form>

                <form th:action="@{/logout}" method="post">
                    <button type="submit" class="px-4 py-2 rounded-lg border border-gray-200 text-sm font-medium hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition whitespace-nowrap">
                        Đăng xuất
                    </button>
                </form>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto bg-gray-50 p-6 lg:p-8">

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">

                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-sv"></div>
                    <h3 class="text-gray-500 font-bold uppercase text-xs tracking-wider mb-6">Tổng điểm học kỳ</h3>

                    <div class="progress-circle mb-4 shadow-inner"
                         th:style="'--percent: ' + ${pointStats.totalPoints} + '%; --color: ' + (${pointStats.totalPoints >= 80} ? '#22c55e' : (${pointStats.totalPoints >= 50} ? '#F97316' : '#ef4444'))">
                        <div class="relative z-10 text-center">
                            <span class="text-4xl font-black text-gray-800 block" th:text="${pointStats.totalPoints}">0</span>
                            <span class="text-xs text-gray-400 font-bold">/ 100</span>
                        </div>
                    </div>

                    <p class="text-sm font-bold" th:classappend="${pointStats.rankColor}" th:text="${pointStats.rankName}">Xuất sắc</p>
                    <p class="text-xs text-gray-500 mt-1" th:text="${pointStats.rankDescription}">Tiếp tục phát huy nhé!</p>
                </div>

                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="font-bold text-gray-800 text-lg">Xét Học Bổng</h3>
                            <div class="w-10 h-10 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center text-lg"><i class="fas fa-graduation-cap"></i></div>
                        </div>

                        <div th:if="${pointStats.isScholarshipEligible}" class="bg-green-50 p-4 rounded-xl border border-green-200 mb-4">
                            <p class="text-green-700 font-bold flex items-center gap-2"><i class="fas fa-check-circle"></i> Đủ điều kiện ĐRL</p>
                            <p class="text-xs text-green-600 mt-1">Bạn đã đạt ngưỡng điểm rèn luyện để xét học bổng.</p>
                        </div>

                        <div th:if="${!pointStats.isScholarshipEligible}" class="bg-orange-50 p-4 rounded-xl border border-orange-200 mb-4">
                            <p class="text-orange-700 font-bold flex items-center gap-2"><i class="fas fa-exclamation-circle"></i> Chưa đủ điều kiện</p>
                            <p class="text-xs text-orange-600 mt-1">Cần thêm <span class="font-black" th:text="${pointStats.pointsNeededForScholarship}">5</span> điểm nữa.</p>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 mb-1">
                            <span>Tiến độ</span>
                            <span th:text="${pointStats.totalPoints} + ' / ' + ${pointStats.scholarshipThreshold}">85/85</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-sv h-2.5 rounded-full transition-all duration-1000"
                                 th:style="'width: ' + (${pointStats.totalPoints} * 100 / ${pointStats.scholarshipThreshold}) + '%'"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="font-bold text-gray-800 text-lg">Mục tiêu tiếp theo</h3>
                            <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-lg"><i class="fas fa-arrow-up"></i></div>
                        </div>

                        <div th:if="${pointStats.totalPoints < 100}">
                            <p class="text-sm text-gray-600 mb-2">Để đạt mức xếp loại tiếp theo, bạn cần tích lũy thêm:</p>
                            <div class="text-center py-4">
                                <span class="text-4xl font-black text-blue-600" th:text="${pointStats.pointsToNextRank}">15</span>
                                <span class="text-sm text-gray-500 font-bold uppercase ml-1">Điểm</span>
                            </div>
                        </div>
                        <div th:if="${pointStats.totalPoints >= 100}" class="text-center py-8">
                            <p class="text-purple-600 font-bold text-lg">Bạn đã đạt điểm tối đa!</p>
                            <i class="fas fa-trophy text-4xl text-yellow-400 mt-3 animate-bounce"></i>
                        </div>
                    </div>

                    <a th:href="@{/student/events}" class="w-full block text-center bg-gray-50 hover:bg-gray-100 text-gray-700 py-2.5 rounded-xl font-bold text-sm transition border border-gray-200">
                        Tìm kiếm sự kiện mới
                    </a>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-5 border-b border-gray-100 bg-gray-50/50">
                    <h3 class="font-bold text-gray-800 text-lg">Chi tiết điểm cộng/trừ</h3>
                </div>
                <table class="w-full text-left">
                    <thead class="bg-white text-xs uppercase text-gray-400 border-b border-gray-100">
                    <tr>
                        <th class="p-4 pl-6">Sự kiện</th>
                        <th class="p-4">Thời gian</th>
                        <th class="p-4 text-center">Trạng thái</th>
                        <th class="p-4 text-center">Điểm số</th>
                    </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50 text-sm">
                    <tr th:if="${#lists.isEmpty(history)}">
                        <td colspan="4" class="p-6 text-center text-gray-400">Chưa có dữ liệu.</td>
                    </tr>
                    <tr th:each="item : ${history}" class="hover:bg-gray-50 transition">
                        <td class="p-4 pl-6 font-medium text-gray-800" th:text="${item.eventTitle}">Event Name</td>
                        <td class="p-4 text-gray-500" th:text="${#temporals.format(item.eventTime, 'dd/MM/yyyy')}">Date</td>
                        <td class="p-4 text-center">
                            <span th:if="${item.attendanceStatus == 'PRESENT'}" class="text-green-600 bg-green-50 px-2 py-1 rounded text-xs font-bold">Tham gia</span>
                            <span th:if="${item.attendanceStatus == 'ABSENT'}" class="text-red-600 bg-red-50 px-2 py-1 rounded text-xs font-bold">Vắng mặt</span>
                        </td>
                        <td class="p-4 text-center font-bold"
                            th:classappend="${item.diemCong >= 0} ? 'text-green-600' : 'text-red-500'"
                            th:text="${item.diemCong > 0 ? '+' + item.diemCong : item.diemCong}">+5</td>
                    </tr>
                    </tbody>
                </table>
            </div>

        </main>
    </div>
</div>
</body>
</html>